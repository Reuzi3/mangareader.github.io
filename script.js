(()=>{var t={sortFlags:{0:"Alphabetical",4:"LastRead",8:"LastUpdate",12:"UnreadCount",16:"TotalChapters",20:"LatestChapter",24:"ChapterFetchDate",28:"DateAdded",64:"Alphabetical",68:"LastRead",72:"LastUpdate",76:"UnreadCount",80:"TotalChapters",84:"LatestChapter",88:"ChapterFetchDate",92:"DateAdded"},fileInput:document.querySelector("#file-input"),fork:document.querySelector("#fork-select"),loadBackup:document.querySelector("#load-backup"),mangaModal:document.querySelector("#manga-modal"),settingsModal:document.querySelector("#settings-modal"),trackingImages:{1:"img/trackers/ic_tracker_mal.webp",2:"img/trackers/ic_tracker_anilist.webp",3:"img/trackers/ic_tracker_kitsu.webp",4:"img/trackers/ic_tracker_shikimori.webp",5:"img/trackers/ic_tracker_bangumi.webp",6:"img/trackers/ic_tracker_komga.webp",7:"img/trackers/ic_tracker_manga_updates.webp",8:"img/trackers/ic_tracker_kavita.webp",9:"img/trackers/ic_tracker_suwayomi.webp",60:"img/trackers/ic_tracker_mdlist.webp"},modalTitle:document.querySelectorAll("#manga-title"),modalSource:document.querySelectorAll("#manga-source"),modalThumb:document.querySelectorAll("#manga-thumbnail"),modalAuthor:document.querySelectorAll("#manga-author"),modalArtist:document.querySelectorAll("#manga-artist"),modalStatus:document.querySelectorAll("#manga-status"),modalCategories:document.querySelectorAll("#manga-categories"),modalTracking:document.querySelectorAll("#manga-tracking"),modalDescription:document.querySelector("#manga-description"),modalDescriptionDiv:document.querySelector("#manga-description-div"),expandDescriptionArrow:document.querySelector(".fade-out"),sortButton:document.querySelector("#chapters-sort-button"),chapterFilterButton:document.querySelector("#chapters-filter-button"),chapterFilterModal:document.querySelector("#chapter-filters-modal"),chapterFilterUnread:document.querySelector("#unread-chapter-filter"),chapterFilterRead:document.querySelector("#read-chapter-filter"),chapterFilterScanlator:document.querySelector("#scanlator-filter"),chapterFilterOkButton:document.querySelector("#apply-chapter-filter"),chapterFilterResetButton:document.querySelector("#reset-chapter-filter"),chapterList:document.querySelector("#manga-chapters"),tabsContainer:document.querySelector("#tabs"),tabContentsContainer:document.querySelector("#tab-contents"),defaultSettings:{filters:{status:["-1"],unread:"all-entries",bookmark:"all-entries",source:["all"],tracker:"all-entries"},sort:{chapters:"asc",library:64},lastFork:"mihon"},settingsIcon:document.querySelector("#settings-icon"),closeSettingsModalBtn:document.querySelector("#close-settings-modal"),applySettingsBtn:document.querySelector("#apply-settings"),closeSettingsBtn:document.querySelector("#close-manga-modal"),filterSource:document.querySelector("#filter-source"),filterUnread:document.querySelector("#filter-unread"),filterBookmark:document.querySelector("#filter-bookmark"),dlJSONBtn:document.querySelector("#download-json"),dlTachibkBtn:document.querySelector("#download-tachibk"),searchButton:document.querySelector("#search > .search-icon"),searchField:document.querySelector("#search > input"),closeEditDetailsModalBtn:document.querySelector("#close-edit-details-modal")};function N(e="mihon"){protobuf.load(`schemas/schema-${e}.proto`,function(c,n){if(c)throw c;var o=n.lookupType("Backup");try{var l=window.data;l.backupCategories=l.backupCategories?.filter(r=>r.order!==-1&&r.order!==65535);var d=o.encode(o.fromObject(l)).finish(),a=pako.gzip(d),p=new Blob([a],{type:"application/octet-stream"}),u=document.createElement("a");u.href=URL.createObjectURL(p),u.download="output.tachibk",document.body.appendChild(u),u.click(),document.body.removeChild(u)}catch{alert("Error: Invalid JSON data")}})}function _(){var e=window.data;e.backupCategories=e.backupCategories?.filter(l=>l.order!==-1&&l.order!==65535);var c=JSON.stringify(e,null,2),n=new Blob([c],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download="EditedBackup",document.body.appendChild(o),o.click(),document.body.removeChild(o)}function b(e){(e instanceof NodeList?e:document.querySelectorAll(`#${e}`))?.forEach(n=>n.classList.remove("active"))}function L(e){(e instanceof NodeList?e:document.querySelectorAll(`#${e}`))?.forEach(n=>n.classList.add("active"))}function E(e,c){let n=document.createElement("span");return n.classList.add("material-symbols-outlined"),n.textContent=c,e instanceof NodeList?e.forEach(o=>o.appendChild(n.cloneNode(!0))):e&&e.appendChild(n.cloneNode(!0)),n}function H(e){e>=0&&e<window.data.backupManga.length&&(window.data.backupManga.splice(e,1),y())}function j(){document.querySelectorAll(".fork-only").forEach(c=>{c.style.display="block"})}function re(){let e=Array.from(document.querySelectorAll(".manga-item-title")).map(d=>d.textContent.trim()),c=JSON.stringify({mangaTitles:e},null,2),n=new Blob([c],{type:"application/json"}),o=URL.createObjectURL(n),l=document.createElement("a");l.href=o,l.download="manga_titles.json",l.click(),URL.revokeObjectURL(o)}var z=document.getElementById("extract-titles-button");z&&z.addEventListener("click",re);var P=document.getElementById("sort-order"),J=document.getElementById("sort-ascending"),G=document.getElementById("filter-status"),V=document.getElementById("filter-tracked");function W(){var e=T();Y(document.querySelector(".tab-content.active").id),e.sort.library=parseInt(P.value)+(J.checked?64:0);var c=[];for(let o of G.options)o.selected&&c.push(o.value);e.filters.status=c,e.filters.unread=t.filterUnread.value,e.filters.bookmark=t.filterBookmark.value;var n=[];for(let o of t.filterSource.options)o.selected&&o.value.split(",").forEach(l=>n.push(l));e.filters.source=n,e.filters.tracker=V.value,B(e),b("settings-modal"),y()}function T(e=!1){var c=JSON.parse(localStorage.getItem("settings"))||t.defaultSettings;if(!e)return c;ae(),ne();for(let[n,o]of Object.entries(c.filters))switch(n){case"status":for(let l of G.options)o.includes(l.value)&&(l.selected=!0);break;case"unread":t.filterUnread.value=o;break;case"bookmark":t.filterBookmark.value=o;break;case"source":for(let l of t.filterSource.options)l.value.split(",").every(d=>o.includes(d))&&(l.selected=!0);break;case"tracker":V.value=o;break;default:break}for(let[n,o]of Object.entries(c.sort))switch(n){case"library":P.value=o<64?o:o-64,J.checked=o>=64;break;case"chapters":o=="asc"&&t.chapterList.classList.remove("desc"),o=="desc"&&(t.chapterList.classList.contains("desc")||t.chapterList.classList.add("desc"));break;default:break}return c}function B(e={},c=!1){var n=T(c);for(let[o,l]of Object.entries(e))n[o]=l;return localStorage.setItem("settings",JSON.stringify(n)),n}function ae(){t.filterSource.innerHTML="";let e=document.createElement("option");e.value="all",e.text="All Sources",t.filterSource.add(e),[...new Set(window.data.backupSources.map(c=>c.name))].sort().map(c=>{var n=new Object;return n.name=c,n.sourceId=window.data.backupSources.filter(o=>o.name===c).map(o=>o.sourceId),n}).forEach(function(c){let n=document.createElement("option");n.value=c.sourceId,n.text=c.name,t.filterSource.add(n)})}function ne(){let e=document.getElementById("filter-status"),c=new Set(window.data.backupManga.map(n=>n.status));for(let n=0;n<e.options.length;n++){let o=e.options[n];o.value!="-1"&&!c.has(parseInt(o.value))?o.disabled=!0:o.disabled=!1}}var M=new URL(window.location),F=null,U=RegExp("^https?://"),I=null;String.prototype.sanitizeId=function(){return btoa(encodeURIComponent(this).replace(/%([0-9A-F]{2})/g,(e,c)=>String.fromCharCode("0x"+c))).replace(/=+$/,"").replace(/[^\d\w]/g,"-")};String.prototype.decodeId=function(){return decodeURIComponent(Array.prototype.map.call(atob(this),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))};function y(){I||(I=le());let e=window.data.backupCategories||[],c=window.data.backupManga,n=document.getElementById("edit-category-options"),o=T(),l=o.filters;t.fork.value!=="mihon"&&j(),c=c.filter(a=>{let p=l.status?.includes("-1")||l.status?.includes(a.status?.toString()),u=l.source?.includes("all")||l.source?.includes(a.source),r=l.tracker==="all-entries"||l.tracker==="tracked"&&a.tracking||l.tracker==="untracked"&&!a.tracking,i=ie(t.searchField.value,a);return p&&u&&r&&i&&X(a,l.unread)&&X(a,l.bookmark)}),Object.keys(l).every(a=>l[a].toString()==t.defaultSettings.filters[a].toString())?t.settingsIcon.classList.remove("filtered"):t.settingsIcon.classList.add("filtered"),e[0]&&!e[0].hasOwnProperty("order")&&(e[0].order="0"),t.tabsContainer.innerHTML="",t.tabContentsContainer.innerHTML="",n.innerHTML="",e.some(a=>a.name==="History")||e.push({name:"History",order:65535}),e.some(a=>a.name==="Default")||e.unshift({name:"Default",order:-1}),e.sort((a,p)=>a.order-p.order).forEach((a,p)=>{let u=document.createElement("button");if(u.className="tab-button",u.id=`btn${a.name.sanitizeId()}`,u.title=u.textContent=a.name,![-1,65535].includes(a.order)){let s=document.createElement("option");s.value=a.order,s.textContent=a.name,n.appendChild(s)}a.order===65535&&(u.textContent=null,E(u,"history"));let r=document.createElement("span");switch(r.className="badge",a.order){default:r.textContent=c.filter(s=>s.favorite!==!1&&s.categories?.indexOf(a.order)>=0).length;break;case-1:r.textContent=c.filter(s=>s.favorite!==!1&&!s.categories).length;break;case 65535:r.textContent=c.filter(s=>s.favorite===!1).length;break}if(u.onclick=()=>D(`tab${a.name.sanitizeId()}`),u.appendChild(r),r.textContent==="0"&&[-1,65535].includes(a.order))return;t.tabsContainer.appendChild(u);let i=document.createElement("div");i.className="tab-content",i.id=`tab${a.name.sanitizeId()}`,i.title=a.name,t.tabContentsContainer.appendChild(i)}),c.sort((a,p)=>{let u=o.sort.library,r=u<64?p:a,i=u<64?a:p;switch(t.sortFlags[u]){default:case"Alphabetical":return r.title.localeCompare(i.title);case"LastRead":return Math.max.apply(0,r.history?.map(s=>parseInt(s.lastRead||"0"))||[0])-Math.max.apply(0,i.history?.map(s=>parseInt(s.lastRead||"0"))||[0]);case"LastUpdated":return r.lastModifiedAt-i.lastModifiedAt;case"UnreadCount":return r.chapters?.filter(s=>!s.read).length-i.chapters?.filter(s=>!s.read).length;case"TotalChapters":return(r.chapters?.length||"0")-(i.chapters?.length||"0");case"LatestChapter":return Math.max.apply(0,r.chapters?.map(s=>parseInt(s.dateUpload||"0")))||[0]-Math.max.apply(0,i.chapters?.map(s=>parseInt(s.dateUpload||"0")))||[0];case"ChapterFetchDate":return(Math.max.apply(0,r.chapters?.map(s=>parseInt(s.dateFetch||"0")))||[0])-(Math.max.apply(0,i.chapters?.map(s=>parseInt(s.dateFetch||"0")))||[0]);case"DateAdded":return parseInt(r.dateAdded||"0")-parseInt(i.dateAdded||"0")}}).forEach((a,p)=>{(a.favorite===!1?[65535]:a.categories||[-1]).forEach(r=>{let i=e.find(f=>f.order===r)||{name:"Default"},s=document.querySelector(`#tab${i.name.sanitizeId()}`),m=a.customTitle||a.title,h=m.length>35?m.substring(0,35)+"\u2026":m,g=document.createElement("div");g.className="manga-item";var x=`${a.title} Chapters: ${a.chapters?.length}`;x+=` | Read: ${a.chapters?.filter(f=>f.read).length}`,a.dateAdded&&(x+=`
Added: ${O(a.dateAdded)}`),a.history&&(x+=`
Last Read: ${O(Math.max.apply(0,a.history.map(f=>parseInt(f.lastRead||"0"))))}`),g.title=x;let k=document.createElement("span");k.classList.add("unread-badge"),k.innerText=a.chapters?.filter(f=>!f.read&&!a.excludedScanlators?.includes(f.scanlator)).length;let w=document.createElement("img");w.loading="lazy",w.src=Q(a),w.alt="";let S=document.createElement("p");S.innerText=h,S.classList.add("manga-item-title");let v=document.createElement("div");v.classList.add("manga-item-container");let C=document.createElement("div");C.classList.add("kebab-menu");let R=window.data.backupManga.indexOf(a);C.hidden=!0,E(C,"more_vert"),C.addEventListener("click",f=>{f.stopPropagation(),K(f,a,R)}),v.appendChild(w),k.innerText>0&&v.appendChild(k),v.appendChild(C),g.appendChild(v),g.appendChild(S),g.addEventListener("click",()=>{ce(a,window.data.backupCategories,I?.find(f=>f.id==a.source)?I?.find(f=>f.id==a.source):window.data.backupSources.find(f=>f.sourceId===a.source))}),g.addEventListener("mouseenter",()=>{S.innerText=m,S.classList.add("full-title"),C.hidden=!1}),g.addEventListener("mouseleave",()=>{S.innerText=h,S.classList.remove("full-title"),C.hidden=!0}),g.addEventListener("contextmenu",f=>{f.preventDefault(),K(f,a,R)}),s.appendChild(g)})});let d=document.getElementById(F)?F:document.querySelector(".tab-content").id;D(d)}function ie(e="",c={title:""}){let n=[],o=[c.title||"",c.artist||"",c.author||"",c.description||"",c.genre?.join(`
`)||""].join(`
`),l=e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&").matchAll(/(?:(?<!\w)-"(?<excludephrase>.+?)"|"(?<phrase>.+?)"|(?<!\w)-(?<exclude>\w+)|(?<word>\S+))/gi);for(let d of l){let a=d.groups,p=a.phrase||a.excludephrase?new RegExp(`\\b${a.phrase||a.excludephrase}\\b`,"gi"):new RegExp(a.word||a.exclude,"gi");(a.excludephrase||a.exclude)&&n.push(o.match(p)===null),(a.phrase||a.word)&&n.push(o.match(p)!==null)}return e?(M.searchParams.set("search",e),t.searchButton.classList.add("filtered")):(M.searchParams.delete("search"),t.searchButton.classList.remove("filtered")),M.toString()!=window.location.toString()&&window.history.replaceState(null,"",M.toString()),n.indexOf(!1)===-1}function D(e){document.querySelectorAll(".tab-content").forEach(d=>d.classList.remove("active"));let n=document.querySelectorAll(".tab-button");n.forEach(d=>d.classList.remove("active"));let o=document.getElementById(e)||document.querySelector(".tab-content");o.classList.add("active");let l=Array.from(n).find(d=>d.id===`btn${o.id}`);l&&l.classList.add("active"),window.scrollTo({top:0,behavior:"smooth"}),ee(o.title),F=e}function ce(e,c,n){let o=I?.find(r=>r.id==e.source),l=E(null,"open_in_new");l.classList.add("link-icon"),t.mangaModal.dataset.index=window.data.backupManga.indexOf(e),t.modalTitle.forEach(r=>{r.textContent=e.customTitle||e.title,r.parentNode.removeAttribute("href"),e.url.match(U)?(r.parentNode.href=e.url,r.appendChild(l.cloneNode(!0))):o&&(r.parentNode.href=o.baseUrl+(e.url[0]=="/"?e.url:`/${e.url}`),r.appendChild(l.cloneNode(!0)))}),t.modalSource.forEach(r=>{if(r.innerHTML="",n.baseUrl){let i=document.createElement("img");i.src=`https://external-content.duckduckgo.com/ip3/${n.baseUrl.split("/")[2]}.ico`,i.height=24,i.classList.add("material-symbols-outlined"),r.append(i);let s=document.createElement("a");s.setAttribute("href",n.baseUrl),s.append(`${n.name} (${n.lang.toUpperCase()})`),s.appendChild(l.cloneNode(!0)),r.append(s)}else E(r,"language"),r.append(n.name)}),t.modalThumb.forEach(r=>r.src=Q(e)),document.documentElement.style.setProperty("--manga-header-bg",`url('${t.modalThumb[0].src}')`);let d=(()=>{switch(e.status){case 1:return["schedule","Ongoing"];case 2:return["done_all","Completed"];case 3:return["attach_money","Licensed"];case 4:return["check","Publishing Finished"];case 5:return["close","Cancelled"];case 6:return["pause","On Hiatus"];default:return["block","Unknown"]}})();t.modalTracking.forEach(r=>{r.innerHTML="",e.tracking?.forEach(i=>{let s=document.createElement("li");if(s.style.backgroundImage=`url(${t.trackingImages[i.syncId]})`,i.trackingUrl.match(U)){let m=document.createElement("a");m.href=i.trackingUrl,m.target="_blank",m.appendChild(s),r.appendChild(m)}else r.appendChild(s)})});let a=document.getElementById("manga-genres");a.innerHTML="",(e.customGenre||e.genre||["None"]).forEach(r=>{let i=document.createElement("li");i.innerText=r,i.addEventListener("click",()=>{t.searchField.value=`"${r.replace(/^[\w\s]+: ?/i,"")}"`,b("manga-modal"),y()}),a.appendChild(i)}),t.modalAuthor.forEach(r=>{r.innerHTML="",E(r,"person"),r.innerHTML+=e.customAuthor||e.author,r.hidden=!e.customAuthor&&!e.author}),t.modalArtist.forEach(r=>{r.innerHTML="",E(r,"brush"),r.innerHTML+=e.customArtist||e.artist,r.hidden=!e.customArtist&&!e.artist}),t.modalDescription.innerText=e.customDescription||e.description,t.modalDescriptionDiv.classList.remove("expanded"),t.modalDescriptionDiv.style.maxHeight="var(--manga-desc-collapsed-height)",document.getElementById("description-expand-icon").style.transform="none",t.modalStatus.forEach(r=>{r.innerHTML="",E(r,d[0]),r.append(d[1])}),t.modalCategories.forEach(r=>{if(r.innerHTML="",e.categories&&e.categories.length>0)e.categories.map(i=>{let s=c.find(m=>m.order===i);return s?s.name:"Default"}).forEach(i=>{let s=document.createElement("li");s.id=i.sanitizeId(),E(s,"label"),s.innerHTML+=i,s.addEventListener("click",function(){b("manga-modal"),D(this.id)}),r.appendChild(s)});else{let i=document.createElement("li");E(i,"label"),i.id="Default",i.innerHTML+="Default",i.addEventListener("click",function(){b("manga-modal"),D(this.id)}),r.appendChild(i)}});let p=document.getElementById("manga-chapters");if(p.innerHTML="",Array.isArray(e.chapters)){e.chapters.sort((i,s)=>i.sourceOrder===void 0?1:s.sourceOrder===void 0?-1:s.sourceOrder-i.sourceOrder);let r=[...new Set(e.chapters.map(i=>i.scanlator).filter(i=>i))];r.length?(t.chapterFilterScanlator.parentNode.hidden=!1,t.chapterFilterScanlator.innerHTML="",r.forEach(i=>{let s=document.createElement("option");s.innerText=i,s.selected=!e.excludedScanlators?.includes(i),t.chapterFilterScanlator.appendChild(s)})):(t.chapterFilterScanlator.innerHTML='<option disabled="true">Any</option>',t.chapterFilterScanlator.parentNode.hidden=!0),e.chapters.forEach(i=>{let s=document.createElement("div");s.className="chapter-box";let m=document.createElement("div");if(i.url.match(U)||o){let h=document.createElement("a");h.target="_blank",o?h.href=o.baseUrl+(i.url[0]=="/"?i.url:`/${i.url}`):h.href=i.url,h.textContent=i.name,h.appendChild(l.cloneNode(!0)),m.appendChild(h)}else m.textContent=i.name;if(i.read&&m.classList.add("read"),i.scanlator){let h=document.createElement("div");h.classList.add("scanlator"),h.textContent=i.scanlator,m.appendChild(h)}if(s.appendChild(m),Array.isArray(e.history)){let h=e.history.find(g=>g.url===i.url);if(h){let g=document.createElement("span");g.className="chapter-date",g.textContent=O(h.lastRead),s.appendChild(g)}}p.appendChild(s)}),t.sortButton.hidden=!1}else t.sortButton.hidden=!0;q(),L("manga-modal"),t.expandDescriptionArrow.hidden=t.modalDescriptionDiv.offsetHeight<parseInt(getComputedStyle(t.modalDescription).fontSize)*parseInt(getComputedStyle(document.body).getPropertyValue("--manga-desc-collapsed-height"));let u=document.querySelector("#manga-modal .modal-content");u.scrollTop=0}function O(e){return new Date(parseInt(e)).toLocaleString()}function Z(){if(t.expandDescriptionArrow.parentNode.classList.toggle("expanded")){let e=t.modalDescription.offsetHeight/parseInt(window.getComputedStyle(t.modalDescription).fontSize)+5;t.modalDescriptionDiv.style.maxHeight=`${e}em`,document.getElementById("description-expand-icon").style.transform="scaleY(-1)"}else document.getElementById("description-expand-icon").style.transform="none",t.modalDescriptionDiv.style.maxHeight="var(--manga-desc-collapsed-height)"}function Q(e){return(e.customThumbnailUrl||e.thumbnailUrl||"").replace(/(?:s.)?exhentai.org(?:\/t)?/,"ehgt.org")}function Y(e){F=e}function X(e=null,c="all-entries"){let n=e?.chapters?.filter(o=>c.search("read")!=-1?!o.read&&!e?.excludedScanlators?.includes(o.scanlator):o.bookmark)?.length;switch(c){case"unread":case"bookmarked":return!!n;case"read":case"unbookmarked":return!n;case"all-entries":default:return!0}}var A=document.getElementById("edit-menu");function K(e,c,n){e.stopPropagation(),A.style.top=`${e.pageY}px`,A.style.left=`${e.pageX}px`,A.classList.add("active"),document.getElementById("delete").onclick=()=>{$(),confirm(`Do you really want to delete ${c.title}`)==!0&&H(n)},document.getElementById("edit").onclick=()=>{$(),L("edit-details-modal");let o=data.backupManga[n],l=p=>{let u=new Date(p*1e3);var r=new Date(u.getTime()-u.getTimezoneOffset()*6e4).toISOString();return r.slice(0,16)};document.getElementById("custom-title").value=o.customTitle||o.title,document.getElementById("custom-artist").value=o.customArtist||o.artist||"",document.getElementById("custom-author").value=o.customAuthor||o.author||"",document.getElementById("custom-thumbnail").value=o.customThumbnailUrl||o.thumbnailUrl,document.getElementById("custom-desc").value=o.customDescription||o.description,document.getElementById("custom-genre").value=o.customGenre?.toString()||o.genre?.toString(),document.getElementById("date-added").value=l(o.dateAdded.slice(0,10)),document.getElementById("last-modified").value=l(o.lastModifiedAt),document.getElementById("favorite-modified").value=l(o.favoriteModifiedAt);let d=document.getElementById("edit-category-options"),a=o.categories;for(let p=0;p<d.options.length;p++)d.options[p].selected=!1;for(let p=0;p<d.options.length;p++){let u=d.options[p];a&&a.includes(u.value)&&(u.selected=!0)}},document.getElementById("apply-edits").onclick=()=>{let o=i=>{if(i){let s=new Date(i);return Math.floor(s.getTime()/1e3).toString()}return null},l=document.getElementById("date-added").value,d=document.getElementById("last-modified").value,a=document.getElementById("favorite-modified").value,p=document.getElementById("edit-category-options"),u=Array.from(p.options).filter(i=>i.selected).map(i=>i.value),r=data.backupManga[n];if(r.dateAdded=`${o(l)}000`,r.lastModifiedAt=o(d),r.favoriteModifiedAt=o(a),r.categories=u,t.fork.value!=="mihon"){let i=document.getElementById("custom-title").value,s=document.getElementById("custom-artist").value,m=document.getElementById("custom-author").value,h=document.getElementById("custom-thumbnail").value,g=document.getElementById("custom-desc").value,x=document.getElementById("custom-genre").value.split(",").map(w=>w.trim()),k=(w,S,v)=>{(w!==r[v]||r[S])&&(r[v]=w,r[v]===r[S]&&delete r[v])};k(i,"title","customTitle"),k(s,"artist","customArtist"),k(m,"author","customAuthor"),k(h,"thumbnailUrl","customThumbnailUrl"),k(g,"description","customDescription"),(x.toString()!==r.customGenre?.toString()||r.genre.toString())&&(r.customGenre=x,r.customGenre?.toString()===r.genre.toString()&&delete r.customGenre)}(r.categories===null||r.categories.length===0)&&delete r.categories,["customTitle","customArtist","customAuthor","customThumbnailUrl","customDescription"].forEach(i=>{r[i]?.length===0&&delete r[i]}),r.customGenre?.length===1&&r.customGenre[0]===""&&delete r.customGenre,b("edit-details-modal"),y()}}function $(){A.classList.remove("active")}document.addEventListener("click",e=>{A.contains(e.target)||$()});function se(){let e=window.data.backupPreferences?.find(l=>l.key=="extension_repos");if(!e)return!1;let c=[],n=new TextEncoder,o=new TextDecoder;try{let l=n.encode(atob(e.value.truevalue));l.forEach(d=>{d==l[0]?c.push([]):c[c.length-1].push(d)}),c.forEach((d,a)=>{c[a]=o.decode(new Uint8Array(d.slice(1)))})}catch{return!1}return c}function le(){let e=se();if(!e)return[];let c=window.data.backupSources?.map(o=>o.sourceId),n=t.fork.value=="sy"?[{name:"E-Hentai",lang:"all",id:"6901",baseUrl:"https://e-hentai.org"},{name:"ExHentai",lang:"all",id:"6902",baseUrl:"https://exhentai.org"}]:[];return e.forEach(o=>{fetch(`${o}/index.min.json`).then(l=>l.json()).then(l=>l.forEach(d=>{d.sources.forEach(a=>{c&&c.length&&!c.includes(a.id)||n.push(a)})})).catch(l=>alert(`Error fetching the repo list. ${l}`))}),n}function q(e=!1){let c=window.data.backupManga[t.mangaModal.dataset.index];e&&(t.chapterFilterUnread.checked=!0,t.chapterFilterRead.checked=!0,Array.from(t.chapterFilterScanlator.options).forEach(o=>o.selected=!o.disabled));let n=Array.from(t.chapterFilterScanlator.selectedOptions).map(o=>o.innerText);!t.chapterFilterScanlator.parentNode.hidden&&n.length<t.chapterFilterScanlator.options.length||!t.chapterFilterUnread.checked||!t.chapterFilterRead.checked?t.chapterFilterButton.classList.add("active"):t.chapterFilterButton.classList.remove("active"),document.querySelectorAll(".chapter-box").forEach(o=>{if(o.hidden=!1,t.chapterFilterButton.classList.contains("active")){if((n.length==0||n.includes(o.querySelector(".scanlator")?.textContent))&&(!t.chapterFilterUnread.checked&&t.chapterFilterRead.checked&&o.firstChild.classList.contains("read")||t.chapterFilterUnread.checked&&!t.chapterFilterRead.checked&&!o.firstChild.classList.contains("read")||t.chapterFilterUnread.checked==t.chapterFilterRead.checked))return;o.hidden=!0}})}function te(e,c="mihon"){let n=e.target.files[0],o=new FileReader;o.onload=l=>{let d=n.name,a=d.split(".").pop().toLowerCase();try{a==="json"?(window.data=JSON.parse(l.target.result),B({lastFork:c},!0),y(),b("load-modal")):a==="tachibk"||d.endsWith(".proto.gz")?protobuf.load(`schemas/schema-${c}.proto`,(p,u)=>{if(p){alert(`Error loading protobuf schema.
${p}`);return}let r=u.lookupType("Backup"),i=new FileReader;i.onload=s=>{try{let m=s.target.result,h=pako.inflate(new Uint8Array(m)),g=r.decode(h);window.data=r.toObject(g,{longs:String,enums:String,bytes:String}),B({lastFork:c},!0),y(),b("load-modal")}catch(m){alert(`Error decoding protobuf file.
${m}`)}},i.readAsArrayBuffer(n)}):alert("Unsupported file type. Please pick a valid .json, .tachibk, or .proto.gz file.")}catch(p){alert(`Error processing the file. Please pick a valid file.
`+p)}},n&&o.readAsText(n)}var oe;function ee(e=null){document.title=e?`${e} - Tachibk Viewer`:"Tachibk Viewer"}document.addEventListener("DOMContentLoaded",()=>{t.fileInput.addEventListener("change",e=>te(e,t.fork.value)),t.settingsIcon.addEventListener("click",L.bind(null,"settings-modal")),t.closeSettingsModalBtn.addEventListener("click",b.bind(null,"settings-modal")),t.applySettingsBtn.addEventListener("click",W),t.dlJSONBtn.addEventListener("click",_),t.dlTachibkBtn.addEventListener("click",e=>N(t.fork.value)),t.closeSettingsBtn.addEventListener("click",b.bind(null,"manga-modal")),t.expandDescriptionArrow.addEventListener("click",Z),t.sortButton.addEventListener("click",()=>{t.chapterList.classList.toggle("desc"),B({sort:{chapters:t.chapterList.classList.contains("desc")?"desc":"asc"}})}),t.chapterFilterButton.addEventListener("click",()=>L("chapter-filters-modal")),t.chapterFilterOkButton.addEventListener("click",()=>{q(),b("chapter-filters-modal")}),t.chapterFilterResetButton.addEventListener("click",()=>{q(!0),b("chapter-filters-modal")}),t.loadBackup.addEventListener("click",e=>{b("settings-modal"),window.data=null,t.tabsContainer.innerHTML="",t.tabContentsContainer.innerHTML="",L("load-modal")}),t.closeEditDetailsModalBtn.addEventListener("click",b.bind(null,"edit-details-modal")),t.searchButton.addEventListener("click",()=>{t.searchField.toggleAttribute("disabled"),t.searchField.disabled||t.searchField.focus()}),t.searchField.addEventListener("blur",()=>t.searchField.disabled=!0),t.searchField.addEventListener("input",()=>{clearTimeout(oe),oe=setTimeout(y,1300)}),document.addEventListener("mousedown",e=>{[t.mangaModal,t.chapterFilterModal,t.settingsModal].includes(e.target)&&e.target.classList.contains("active")&&b(e.target.id)}),L("load-modal"),t.fork.value=T().lastFork});})();
